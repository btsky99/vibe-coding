# AI 작업 통합 모니터 (ai-monitor) — 범용 설계 및 보안 계획서

> 버전: v2.0 (범용/보안 강화판) / 작성: 2026-02-21
> 목적: 4개 이상의 터미널에서 구동되는 다중 AI 에이전트(Claude, Gemini 등) 작업 및 상태를 단일 뷰어로 통합 모니터링하며, 시스템 보안 및 동시성을 보장

---

## 1. 개요

### 문제 상황 (기본 4 터미널 환경)
- 개발 시 기본적으로 **4개 이상의 터미널 창**(예: 프론트엔드 작업용, 백엔드 작업용, 서버 실행용, CLI 작업용)을 띄워두고 다중 AI 에이전트 동시 사용.
- 각 터미널에서 일어나는 AI 코드 수정, 스크립트 실행이 파편화되어 **전체 진행 맥락 상실**.
- 동일 프로젝트 내 동시 다발적 파일 수정으로 인한 **Git 충돌, 파일 덮어쓰기 위험**.

### 해결 전략 (범용성 및 보안 확보)
1. **단일 진실 공급원(Single Source of Truth, SSOT)**: 모든 터미널 기반 AI 작업은 로컬 소켓/또는 단일 파일로 텔레메트리(로그) 전송.
2. **독립적 모니터링 뷰어**: 5번째 터미널 요소로 띄워, 4개 터미널에서 발생 중인 AI 프로세스를 그룹화/필터링하여 보여줌.
3. **환경 독립성**: 어떤 OS, 어떤 Python 버전에서도 독립 실행 가능하도록 `venv` 또는 래퍼(Wrapper) 스크립트 제공.
4. **보안성 내재화**: IPC, 인증, 데이터 마스킹 등을 통해 개발망 보안을 강화.

---

## 2. 파일 및 권한 구조

```text
~/.ai_monitor/
├── venv/                 # 격리된 가상환경 (의존성 충돌 방지)
├── bin/
│   ├── aimon           # 뷰어 실행 래퍼 CLI
│   └── logger          # 로깅 헬퍼 래퍼 CLI
├── src/
│   ├── logger.py       # 로컬 통신/파일 쓰기 헬퍼
│   ├── view.py         # 4분할/리스트 터미널 뷰어 UI (Rich/Textual)
│   └── secure.py       # 보안 관련 모듈 (입력값 검증, 마스킹)
├── config.json           # 환경설정
├── .env                  # 로컬 환경 변수 (보안 요소 설정 등)
├── data/
│   ├── sessions.jsonl    # 암호화·로테이션 적용된 데이터
│   └── sessions.lock     # 동시성 제어 락
└── certs/                # (확장) IPC 소켓, 로컬 서버용 인증서/키 보관 (옵션)
```
- **권한 원칙**: 디렉토리 및 파일은 실행 권한을 가진 유저 본인에게만 최소 권한 `chmod 700 / ~/.ai_monitor` 부여.

---

## 3. 핵심 보안 고려사항 (Security Points)

### 3-A. 명령어 주입 (Command Injection) 방어
- CLI 인자 파싱 시, Shell 특수문자(`;`, `|`, `&`, `$()`) 우회가 불가능하게 JSON 페이로드 파일이나 Base64 인코딩 스트링으로만 인자를 수신하여, Python 내부에서 `shlex` 역직렬화 처리.
- `os.system` 절대 금지, `subprocess.run` 배열 형식 실행 엄수.

### 3-B. 무결성 및 동시성 (Concurrency)
- 터미널 4개 동시 로그 기록 시 파일 손상 방지를 위한 `filelock` 대기 시간 최적화.
- 장기적으로 파일 I/O 병목 해소를 위한 **Local Socket 통신 (또는 UDS - Unix Domain Socket)** 적용 옵션, 파일 직접 쓰기 대신 백그라운드 데몬(Daemon)으로 릴레이.

### 3-C. 민감 정보(Secret) 마스킹 기능
- 코드 수정 로그나 Trigger 메시지 내에 포함될 수 있는 API Key, Password 패턴(예: `sk_...`, `Bearer ...`) 정규식 자동 마스킹.
- `secure.py`를 거쳐 `[MASKED]` 처리된 데이터만 `sessions.jsonl`에 기록.

### 3-D. 경로 탐색(Directory Traversal) 방어
- `project_path`나 변경 파일 목록에 `../`나 절대경로 우회를 시도하는 것을 정규화하여 작업 공간 경로(`D:/clim` 등) 내부인지 검증(Sandbox 원칙).

### 3-E. 데이터 폭주 방어 (DoS Mitigation)
- `sessions.jsonl` 최대 용량 제한(Log Rotation). `config.json`의 `max_log_mb` (예: 10MB) 초과 시 자동 아카이빙 및 압축 처리.

---

## 4. 데이터 구조 (sessions.jsonl - 보안 마스킹 적용)

```json
{
  "session_id": "abc123_4",           // 식별자 (난수화 + 터미널 구분용)
  "terminal_id": "TERM_1",            // 발생 진원지 추적 (4개 터미널 식별용)
  "ts_start": "2026-02-21T09:15:00",
  "ts_end":   "2026-02-21T09:15:45",
  "project": "clim",
  "project_path": "D:/clim",          // 경로 검증 완료
  "agent": "gemini",
  "skill": "master",
  "trigger": "마스킹된 설정파일 수정 [MASKED]",
  "status": "success",
  "duration_sec": 45,
  "commit": "dc9f8e0b",
  "files_changed": [
    "src/components/secure_panel.py"
  ],
  "phases": [ ... ]
}
```

---

## 5. UI/UX: 4 터미널 대응 뷰어 설계 (view.py)

단순 리스트 뷰를 넘어, 터미널 4개 동시 송출 상황을 직관적으로 보여주는 Textual/Rich 기반의 하이브리드 대시보드.

**뷰 옵션 A: 통합 리스트형 (시간순)**
```text
[필터: AI 전체 | 프로젝트: 전체 | 터미널: ALL]
─────────────────────────────────────────────────────────────────
 TERM_1 | 09:15 | clim | Gemini | 작업: 설정파일 수정   | ✅ (45s)
 TERM_3 | 09:14 | shop | Claude | 작업: UI 개선         | 🔄 (진행)
 TERM_2 | 09:12 | clim | Gemini | 작업: DB 마이그레이션 | ❌ (에러)
 TERM_4 | 09:10 | test | Claude | 작업: 테스트 스크립트 | ✅ (12s)
─────────────────────────────────────────────────────────────────
```

**뷰 옵션 B: 4분할 격자형 (터미널별 Focus View)**
```text
┌── [ TERM 1 : clim (Gemini) ] ──────────┐┌── [ TERM 2 : clim (Gemini) ] ──────────┐
│ 작업: 설정파일 수정 (진행)             ││ 작업: DB 마이그레이션 (에러)           │
│  [✅] 사전 분석                        ││  [✅] 연결 확인                        │
│  [🔄] 코드 쓰기 중...                  ││  [❌] 테이블 충돌 발생!                │
└────────────────────────────────────────┘└────────────────────────────────────────┘
┌── [ TERM 3 : shop (Claude) ] ──────────┐┌── [ TERM 4 : test (Claude) ] ──────────┐
│ 작업: UI 버튼 추가 (성공)              ││ 작업: e2e 테스트 스크립트 작성 (성공)  │
│ 완료 소요시간: 45초, 파일 1개 변경     ││ 완료 소요시간: 12초                    │
└────────────────────────────────────────┘└────────────────────────────────────────┘
```
- [Tab] 키를 눌러 뷰 모드 전환.
- 서로 다른 터미널에서 동일 파일(ex. `package.json`)을 동시 수정 시 뷰어에서 **🚨 긴급 경고 메시지(Conflict Warning)** 점멸 표시.

---

## 6. 구현 단계 조정 (로드맵)

| 단계 | 보안/기능 | 예상 작업량 |
|------|-----------|-----------|
| **Phase 0** | 로컬 `.ai_monitor/venv` 환경 구축 및 Directory 권한 설정(`700`) | 소 |
| **Phase 1** | `secure.py` 구현 (경로 검증, 마스킹 규칙 적용, Base64 통신 파서) | 중 |
| **Phase 2** | `logger.py` 업그레이드 (filelock 안정화, log rotation 적용, JSON/Base64 입력) | 중 |
| **Phase 3** | 다중 터미널 뷰 (4분할 및 리스트) UI 구현 (`Textual` 라이브러리 활용 추천) | 대 |
| **Phase 4** | /master, Gemini CLI 등에서 Logger 호출 시 터미널 ID(`$TERM_ID`) 주입 로직 추가 | 소 |
| **Phase 5** | 동시 수정 충돌 감지(Conflict Warning) 로직 추가 | 중 |

---

## 7. 차기 연동(Integration) 원칙
- 모든 헬퍼 스크립트는 `~/.ai_monitor/bin/` 래퍼에 등록되어 전역적으로 동작.
- AI 스킬에서 Bash 커맨드 호출 시, 보안 검증이 통과된 래퍼 스크립트를 사용하여 일관성을 확보한다.
