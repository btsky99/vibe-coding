name: Build & Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install -r .ai_monitor/requirements.txt

      - name: Lint & syntax check (Python)
        run: |
          pip install ruff
          python -m py_compile .ai_monitor/server.py
          ruff check .ai_monitor/server.py --select E9,F821,F823

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build frontend
        run: |
          cd .ai_monitor/vibe-view
          npm ci
          npm run build

      - name: Resolve version (auto-bump patch if tag already exists)
        id: version
        run: |
          # _version.py에서 기준 버전 읽기
          $base = python -c "exec(open('.ai_monitor/_version.py').read()); print(__version__)"
          $parts = $base -split "\."
          $major = $parts[0]; $minor = $parts[1]; $patch = [int]$parts[2]

          # 동일 태그가 이미 GitHub에 존재하면 패치 버전을 자동 증가
          # (버전 미변경 커밋이 push 됐을 때 릴리스 중복 방지)
          $ver = $base
          while ($true) {
            $checkTag = "v$ver"
            gh release view $checkTag > $null 2>&1
            if ($LASTEXITCODE -ne 0) { break }   # 이 태그가 없으면 사용 확정
            $patch++
            $ver = "$major.$minor.$patch"
          }

          # 버전이 변경된 경우 → _version.py 업데이트 후 main에 커밋 (무한 루프 방지: [skip ci])
          if ($ver -ne $base) {
            Set-Content -Path ".ai_monitor/_version.py" -Value "__version__ = `"$ver`""
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add .ai_monitor/_version.py
            git commit -m "chore(release): auto-bump version to v$ver [skip ci]"
            git push
            Write-Host "Auto-bumped: $base -> $ver"
          }

          echo "tag=v$ver" >> $env:GITHUB_OUTPUT
          echo "ver=$ver" >> $env:GITHUB_OUTPUT
          Write-Host "Final version: v$ver"
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find winpty binaries path
        id: winpty
        run: |
          import winpty, os
          wp = os.path.dirname(winpty.__file__)
          print(f"path={wp}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"path={wp}\n")
        shell: python

      - name: Sync icons and assets
        run: |
          copy assets\vibe_coding_icon.ico .ai_monitor\bin\app_icon.ico /y
          copy assets\vibe_coding_icon.ico .ai_monitor\bin\vibe_final.ico /y
        shell: cmd

      - name: Bundle skills into .ai_monitor
        run: |
          xcopy skills .ai_monitor\skills /E /I /Y
          xcopy .gemini\skills .ai_monitor\.gemini\skills /E /I /Y
          xcopy scripts .ai_monitor\scripts /E /I /Y
          copy GEMINI.md .ai_monitor\GEMINI.md /Y
          copy CLAUDE.md .ai_monitor\CLAUDE.md /Y
          copy RULES.md .ai_monitor\RULES.md /Y
        shell: cmd

      - name: Build exe
        run: |
          cd .ai_monitor
          set WINPTY=${{ steps.winpty.outputs.path }}
          pyinstaller --onefile --noconsole ^
            --name vibe-coding ^
            --icon bin/vibe_final.ico ^
            --add-data "src;src" ^
            --add-data "bin;bin" ^
            --add-data "vibe-view\dist;dist" ^
            --add-data "skills;skills" ^
            --add-data ".gemini\skills;.gemini/skills" ^
            --add-data "scripts;scripts" ^
            --add-data "GEMINI.md;." ^
            --add-data "CLAUDE.md;." ^
            --add-data "RULES.md;." ^
            --add-binary "%WINPTY%\winpty.dll;winpty" ^
            --add-binary "%WINPTY%\winpty-agent.exe;winpty" ^
            --add-binary "%WINPTY%\conpty.dll;winpty" ^
            --add-binary "%WINPTY%\OpenConsole.exe;winpty" ^
            --hidden-import websockets ^
            --hidden-import winpty ^
            server.py
        shell: cmd

      - name: Build exe (console)
        run: |
          cd .ai_monitor
          set WINPTY=${{ steps.winpty.outputs.path }}
          pyinstaller --onefile --console ^
            --name vibe-coding_console ^
            --icon bin/vibe_final.ico ^
            --add-data "src;src" ^
            --add-data "bin;bin" ^
            --add-data "vibe-view\dist;dist" ^
            --add-data "skills;skills" ^
            --add-data ".gemini\skills;.gemini/skills" ^
            --add-data "scripts;scripts" ^
            --add-data "GEMINI.md;." ^
            --add-data "CLAUDE.md;." ^
            --add-data "RULES.md;." ^
            --add-binary "%WINPTY%\winpty.dll;winpty" ^
            --add-binary "%WINPTY%\winpty-agent.exe;winpty" ^
            --add-binary "%WINPTY%\conpty.dll;winpty" ^
            --add-binary "%WINPTY%\OpenConsole.exe;winpty" ^
            --hidden-import websockets ^
            --hidden-import winpty ^
            server.py
        shell: cmd

      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress
        shell: cmd

      - name: Build installer
        run: |
          "%ProgramFiles(x86)%\Inno Setup 6\ISCC.exe" ".ai_monitor/installer.iss" /DMyAppVersion="${{ steps.version.outputs.ver }}"
        shell: cmd

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Vibe Coding ${{ steps.version.outputs.tag }}"
          body: |
            자동 빌드 릴리스
            - Commit: ${{ github.sha }}
            - 빌드 시간: ${{ github.event.head_commit.timestamp }}
          files: |
            .ai_monitor/dist/vibe-coding-setup-${{ steps.version.outputs.ver }}.exe
            .ai_monitor/dist/vibe-coding.exe
