name: Build & Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install -r .ai_monitor/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build frontend
        run: |
          cd .ai_monitor/nexus-view
          npm ci
          npm run build

      - name: Generate version tag
        id: version
        run: |
          $date = Get-Date -Format "yyyy.MM.dd"
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $tag = "v$date-$shortSha"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "Version: $tag"
        shell: pwsh

      - name: Embed version in source
        run: |
          $tag = "${{ steps.version.outputs.tag }}"
          Set-Content -Path ".ai_monitor/_version.py" -Value "__version__ = `"$tag`""
          Write-Output "Embedded version: $tag"
        shell: pwsh

      - name: Build exe
        run: |
          cd .ai_monitor
          pyinstaller --onefile --noconsole ^
            --name vibe-coding ^
            --icon bin/app_icon.ico ^
            --add-data "nexus-view\dist;nexus-view/dist" ^
            --hidden-import websockets ^
            --hidden-import winpty ^
            server.py
        shell: cmd

      - name: Build exe (console)
        run: |
          cd .ai_monitor
          pyinstaller --onefile --console ^
            --name vibe-coding_console ^
            --icon bin/app_icon.ico ^
            --hidden-import textual ^
            --hidden-import rich ^
            src/view.py
        shell: cmd

      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress
        shell: cmd

      - name: Build installer
        run: |
          "%ProgramFiles(x86)%\Inno Setup 6\ISCC.exe" ".ai_monitor/installer.iss" /DMyAppVersion="${{ steps.version.outputs.tag }}"
        shell: cmd

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Vibe Coding ${{ steps.version.outputs.tag }}"
          body: |
            자동 빌드 릴리스
            - Commit: ${{ github.sha }}
            - 빌드 시간: ${{ github.event.head_commit.timestamp }}
          files: |
            .ai_monitor/dist/vibe-coding.exe
            .ai_monitor/dist/vibe-coding_console.exe
            .ai_monitor/dist/vibe-coding-setup.exe
