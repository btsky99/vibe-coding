name: Build & Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install -r .ai_monitor/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build frontend
        run: |
          cd .ai_monitor/nexus-view
          npm ci
          npm run build

      - name: Build exe (aimon)
        run: |
          cd .ai_monitor
          pyinstaller --onefile --noconsole ^
            --name aimon ^
            --icon bin/app_icon.ico ^
            --hidden-import websockets ^
            --hidden-import winpty ^
            server.py
        shell: cmd

      - name: Build exe (aimon_console)
        run: |
          cd .ai_monitor
          pyinstaller --onefile --console ^
            --name aimon_console ^
            --icon bin/app_icon.ico ^
            bin/aimon_wrapper.py
        shell: cmd

      - name: Generate version tag
        id: version
        run: |
          $date = Get-Date -Format "yyyy.MM.dd"
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $tag = "v$date-$shortSha"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "Version: $tag"
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "AI Monitor ${{ steps.version.outputs.tag }}"
          body: |
            자동 빌드 릴리스
            - Commit: ${{ github.sha }}
            - 빌드 시간: ${{ github.event.head_commit.timestamp }}
          files: |
            .ai_monitor/dist/aimon.exe
            .ai_monitor/dist/aimon_console.exe
